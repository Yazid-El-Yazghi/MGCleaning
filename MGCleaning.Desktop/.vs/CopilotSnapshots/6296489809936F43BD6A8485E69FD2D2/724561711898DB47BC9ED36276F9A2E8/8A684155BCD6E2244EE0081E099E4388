using System.Windows;
using System.Windows.Controls;
using MGCleaning.Desktop.Services;
using MGCleaning.Models;

namespace MGCleaning.Desktop.Views;

public partial class CalculatorWindow : Window
{
    private readonly GebouwService _gebouwService;
    private readonly ProductService _productService;

    public CalculatorWindow(GebouwService gebouwService, ProductService productService)
    {
        InitializeComponent();
        _gebouwService = gebouwService;
        _productService = productService;
        Loaded += CalculatorWindow_Loaded;
    }

    private async void CalculatorWindow_Loaded(object sender, RoutedEventArgs e)
    {
        await LaadCalculatorDataAsync();
    }

    private async Task LaadCalculatorDataAsync()
    {
        try
        {
            var gebouwen = await _gebouwService.GetAlleGebouwenAsync();
            var producten = await _productService.GetAlleProductenAsync();

            if (!gebouwen.Any() || !producten.Any())
            {
                MessageBox.Show("Geen gebouwen of producten gevonden.", "Informatie", 
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            // Maak DataGrid kolommen dynamisch
            CalculatorDataGrid.Columns.Clear();

            // Eerste kolom: Gebouw naam
            var gebouwColumn = new DataGridTextColumn
            {
                Header = "Gebouw",
                Binding = new System.Windows.Data.Binding("GebouwNaam"),
                Width = new DataGridLength(200),
                IsReadOnly = true
            };
            CalculatorDataGrid.Columns.Add(gebouwColumn);

            // Oppervlakte kolom
            var oppervlakteColumn = new DataGridTextColumn
            {
                Header = "Oppervlakte (m²)",
                Binding = new System.Windows.Data.Binding("Oppervlakte"),
                Width = new DataGridLength(120),
                IsReadOnly = true
            };
            CalculatorDataGrid.Columns.Add(oppervlakteColumn);

            // Voor elk product een kolom
            foreach (var product in producten)
            {
                var productColumn = new DataGridTextColumn
                {
                    Header = $"{product.Naam}\n(per 100m²: {product.HoeveelheidPer100M2Display}L)",
                    Binding = new System.Windows.Data.Binding($"Product_{product.Id}"),
                    Width = new DataGridLength(150),
                    IsReadOnly = true
                };
                CalculatorDataGrid.Columns.Add(productColumn);
            }

            // Bereken data voor elk gebouw
            var calculatorData = new List<dynamic>();

            foreach (var gebouw in gebouwen)
            {
                var row = new System.Dynamic.ExpandoObject() as IDictionary<string, object>;
                row["GebouwNaam"] = gebouw.Naam;
                row["Oppervlakte"] = $"{gebouw.OppervlakteM2:N0}";

                foreach (var product in producten)
                {
                    // Bereken benodigde hoeveelheid
                    // Formule: (Oppervlakte / 100) * HoeveelheidPer100M2
                    decimal benodigdeLiters = 0;

                    if (product.HoeveelheidPerM2 > 0)
                    {
                        // Bereken op basis van m²
                        benodigdeLiters = (gebouw.OppervlakteM2 / 100) * product.HoeveelheidPer100M2Display;
                    }

                    row[$"Product_{product.Id}"] = $"{benodigdeLiters:N2} L";
                }

                calculatorData.Add(row);
            }

            // Voeg totaal rij toe
            var totaalRow = new System.Dynamic.ExpandoObject() as IDictionary<string, object>;
            totaalRow["GebouwNaam"] = "TOTAAL";
            totaalRow["Oppervlakte"] = $"{gebouwen.Sum(g => g.OppervlakteM2):N0}";

            foreach (var product in producten)
            {
                decimal totaalLiters = 0;

                foreach (var gebouw in gebouwen)
                {
                    if (product.HoeveelheidPerM2 > 0)
                    {
                        totaalLiters += (gebouw.OppervlakteM2 / 100) * product.HoeveelheidPer100M2Display;
                    }
                }

                totaalRow[$"Product_{product.Id}"] = $"{totaalLiters:N2} L";
            }

            calculatorData.Add(totaalRow);

            CalculatorDataGrid.ItemsSource = calculatorData;
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Fout bij laden calculator data: {ex.Message}", "Fout", 
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private async void RefreshButton_Click(object sender, RoutedEventArgs e)
    {
        await LaadCalculatorDataAsync();
    }

    private void TerugButton_Click(object sender, RoutedEventArgs e)
    {
        Close();
    }
}
