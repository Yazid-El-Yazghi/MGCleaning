using System.Windows;
using System.Windows.Controls;
using MGCleaning.Desktop.Services;

namespace MGCleaning.Desktop.Views;

public partial class AccountWindow : Window
{
    private readonly AuthService _authService;
    private bool _isAdmin;
    private bool _isManager;

    public AccountWindow(AuthService authService)
    {
        InitializeComponent();
        _authService = authService;
        Loaded += AccountWindow_Loaded;
    }

    private async void AccountWindow_Loaded(object sender, RoutedEventArgs e)
    {
        await UpdateAccountInfoAsync();
        await ConfigureRoleBasedAccessAsync();
    }

    private async Task ConfigureRoleBasedAccessAsync()
    {
        if (_authService.HuidigeGebruiker == null)
            return;

        var rollen = await _authService.GetRollenAsync(_authService.HuidigeGebruiker);
        _isAdmin = rollen.Contains("Admin");
        _isManager = rollen.Contains("Manager");

        // Nieuwe User tab alleen zichtbaar voor Admin en Manager
        NieuweUserTab.Visibility = (_isAdmin || _isManager) ? Visibility.Visible : Visibility.Collapsed;

        // Rol combobox opties configureren
        RegisterRolComboBox.Items.Clear();
        
        if (_isAdmin)
        {
            // Admin kan alle rollen aanmaken
            RegisterRolComboBox.Items.Add(new ComboBoxItem { Content = "Admin" });
            RegisterRolComboBox.Items.Add(new ComboBoxItem { Content = "Manager" });
            RegisterRolComboBox.Items.Add(new ComboBoxItem { Content = "Schoonmaker" });
            RegisterRolComboBox.SelectedIndex = 2; // Default: Schoonmaker
        }
        else if (_isManager)
        {
            // Manager kan alleen Schoonmakers aanmaken
            RegisterRolComboBox.Items.Add(new ComboBoxItem { Content = "Schoonmaker" });
            RegisterRolComboBox.SelectedIndex = 0;
        }
    }

    private async Task UpdateAccountInfoAsync()
    {
        if (_authService.HuidigeGebruiker != null)
        {
            AccountInfoTextBlock.Text = $"Gebruikersnaam: {_authService.HuidigeGebruiker.UserName}\n" +
                                        $"Email: {_authService.HuidigeGebruiker.Email}\n" +
                                        $"Telefoonnummer: {_authService.HuidigeGebruiker.Telefoonnummer}\n" +
                                        $"Adres: {_authService.HuidigeGebruiker.Adres}";

            var rollen = await _authService.GetRollenAsync(_authService.HuidigeGebruiker);
            AccountRolTextBlock.Text = $"Rol(len): {string.Join(", ", rollen)}";
        }
        else
        {
            AccountInfoTextBlock.Text = "Niet ingelogd";
            AccountRolTextBlock.Text = "";
        }
    }

    private async void RegisterenButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            RegisterStatusTextBlock.Text = "";
            RegisterStatusTextBlock.Foreground = System.Windows.Media.Brushes.Red;

            if (string.IsNullOrWhiteSpace(RegisterUsernameTextBox.Text))
            {
                RegisterStatusTextBlock.Text = "Gebruikersnaam is verplicht.";
                return;
            }

            if (string.IsNullOrWhiteSpace(RegisterWachtwoordBox.Password))
            {
                RegisterStatusTextBlock.Text = "Wachtwoord is verplicht.";
                return;
            }

            if (RegisterWachtwoordBox.Password.Length < 5)
            {
                RegisterStatusTextBlock.Text = "Wachtwoord moet minimaal 5 karakters zijn.";
                return;
            }

            var rol = (RegisterRolComboBox.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Schoonmaker";

            var success = await _authService.RegisterAsync(
                RegisterUsernameTextBox.Text,
                RegisterWachtwoordBox.Password,
                RegisterEmailTextBox.Text,
                RegisterTelefoonTextBox.Text,
                RegisterAdresTextBox.Text,
                rol
            );

            if (success)
            {
                RegisterStatusTextBlock.Foreground = System.Windows.Media.Brushes.Green;
                RegisterStatusTextBlock.Text = "Gebruiker succesvol aangemaakt!";
                
                // Clear form
                RegisterUsernameTextBox.Clear();
                RegisterWachtwoordBox.Clear();
                RegisterEmailTextBox.Clear();
                RegisterTelefoonTextBox.Clear();
                RegisterAdresTextBox.Clear();
                RegisterRolComboBox.SelectedIndex = _isAdmin ? 2 : 0;
            }
            else
            {
                RegisterStatusTextBlock.Text = "Aanmaken mislukt. Gebruikersnaam bestaat mogelijk al.";
            }
        }
        catch (Exception ex)
        {
            RegisterStatusTextBlock.Text = $"Fout: {ex.Message}";
        }
    }

    private async void UitloggenButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            var result = MessageBox.Show("Weet u zeker dat u wilt uitloggen?", "Uitloggen", 
                MessageBoxButton.YesNo, MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                await _authService.LogoutAsync();
                
                // Sluit alle windows en herstart applicatie
                Application.Current.Shutdown();
                System.Diagnostics.Process.Start(
                    System.Diagnostics.Process.GetCurrentProcess().MainModule!.FileName);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Fout bij uitloggen: {ex.Message}", "Fout", 
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void SluitenButton_Click(object sender, RoutedEventArgs e)
    {
        Close();
    }
}
