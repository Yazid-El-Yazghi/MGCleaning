using System.Windows;
using MGCleaning.Models;
using MGCleaning.Desktop.Services;
using Microsoft.AspNetCore.Identity;

namespace MGCleaning.Desktop.Views;

public partial class UserEditDialog : Window
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly AuthService _authService;
    private readonly ApplicationUser _user;
    private readonly bool _isAdmin;

    public UserEditDialog(UserManager<ApplicationUser> userManager, AuthService authService, ApplicationUser user, bool isAdmin)
    {
        InitializeComponent();
        _userManager = userManager;
        _authService = authService;
        _user = user;
        _isAdmin = isAdmin;

        Loaded += UserEditDialog_Loaded;
    }

    private async void UserEditDialog_Loaded(object sender, RoutedEventArgs e)
    {
        // Vul formulier in
        UsernameTextBox.Text = _user.UserName;
        EmailTextBox.Text = _user.Email;
        TelefoonnummerTextBox.Text = _user.Telefoonnummer;
        AdresTextBox.Text = _user.Adres;

        // Rol panel alleen zichtbaar voor Admin
        RolPanel.Visibility = _isAdmin ? Visibility.Visible : Visibility.Collapsed;

        if (_isAdmin)
        {
            // Check of gebruiker zichzelf bewerkt
            var isEditingSelf = _user.Id == _authService.HuidigeGebruiker?.Id;
            
            if (isEditingSelf)
            {
                // Admin kan zijn eigen rol niet wijzigen
                RolComboBox.IsEnabled = false;
                var label = RolPanel.Children.OfType<System.Windows.Controls.Label>().FirstOrDefault();
                if (label != null)
                {
                    label.Content = "Rol (niet bewerkbaar voor eigen account):";
                }
            }

            // Huidige rol selecteren
            var rollen = await _userManager.GetRolesAsync(_user);
            if (rollen.Contains("Admin"))
                RolComboBox.SelectedIndex = 0;
            else if (rollen.Contains("Manager"))
                RolComboBox.SelectedIndex = 1;
            else
                RolComboBox.SelectedIndex = 2;
        }
    }

    private async void OpslaanButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            // Update basis gegevens
            _user.Email = EmailTextBox.Text;
            _user.Telefoonnummer = TelefoonnummerTextBox.Text;
            _user.Adres = AdresTextBox.Text;

            var result = await _userManager.UpdateAsync(_user);

            if (!result.Succeeded)
            {
                MessageBox.Show("Fout bij opslaan gegevens.", "Fout", 
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // Update wachtwoord als ingevuld
            if (!string.IsNullOrWhiteSpace(NieuwWachtwoordBox.Password))
            {
                if (NieuwWachtwoordBox.Password.Length < 5)
                {
                    MessageBox.Show("Wachtwoord moet minimaal 5 karakters zijn.", "Validatie", 
                        MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                var token = await _userManager.GeneratePasswordResetTokenAsync(_user);
                var passwordResult = await _userManager.ResetPasswordAsync(_user, token, NieuwWachtwoordBox.Password);

                if (!passwordResult.Succeeded)
                {
                    MessageBox.Show("Fout bij wijzigen wachtwoord.", "Fout", 
                        MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }
            }

            // Update rol als admin en gewijzigd
            if (_isAdmin && RolComboBox.SelectedIndex >= 0)
            {
                var nieuweRol = ((System.Windows.Controls.ComboBoxItem)RolComboBox.SelectedItem).Content.ToString();
                var huidigeRollen = await _userManager.GetRolesAsync(_user);

                if (nieuweRol != null && !huidigeRollen.Contains(nieuweRol))
                {
                    // Verwijder alle oude rollen
                    await _userManager.RemoveFromRolesAsync(_user, huidigeRollen);
                    
                    // Voeg nieuwe rol toe
                    await _userManager.AddToRoleAsync(_user, nieuweRol);
                }
            }

            MessageBox.Show("Gebruiker succesvol bijgewerkt!", "Succes", 
                MessageBoxButton.OK, MessageBoxImage.Information);

            DialogResult = true;
            Close();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Fout bij opslaan: {ex.Message}", "Fout", 
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void AnnulerenButton_Click(object sender, RoutedEventArgs e)
    {
        DialogResult = false;
        Close();
    }
}
